---
sidebar: sidebar
permalink: backup/anf-cba-backup-operations-with-hana-system-replication.html
keywords: system replication, cba, hsr, multiple host, standby host
summary: "This section describes how to perform backup operations with HANA system replication."
---

= Backup operations with HANA System Replication
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./../media/

//
// This file was created with NDAC Version 2.0 (August 17, 2020)
//
// 2023-03-16 10:24:27.321926
//

link:anf-cba-restore-and-recovery-from-snapshot-backup.html[Previous: Restore and recovery from Snapshot backup.]

== Storage Snapshot backups and HANA System Replication

Backup operations are always performed at the primary SAP HANA host because the required SQL commands for the backup operation cannot be performed at the secondary SAP HANA host.

For SAP HANA backup operations, the primary and secondary SAP HANA hosts are a single entity. They share the same SAP HANA backup catalog, and they use backups for restore and recovery, regardless of whether the backup was created at the primary or secondary SAP HANA host.

The ability to use any backup for restore and to do forward recovery using log backups from both hosts requires a shared log backup location that is accessible from both hosts. NetApp recommends that you use a shared storage volume. However, you should also separate the log backup destination into subdirectories within the shared volume.

Each SAP HANA host has its own storage volume. When you use a storage-based Snapshot to perform a backup, a database-consistent Snapshot copy is created on the primary SAP HANA host’s storage volume.

image:anf-cba-image102.png["This figure shows how a database-consistent Snapshot copy is created on the primary SAP HANA host’s storage volume."]

When a failover to host 2 is performed, host 2 becomes the primary SAP HANA host, backups are now executed at host 2, and Snapshot backups are created at the storage volume of host 2.

The backup created at host 2 can be restored directly at the storage layer. If you must use a backup created at host 1, then the backup must be copied from the host 1 storage volume to the host 2 storage volume. Forward recovery uses the log backups from both hosts.

image:anf-cba-image103.png["This figure shows how forward recovery uses the log backups from both hosts."]

== Backup operations with CBA- and HSR-enabled HANA systems

As briefly discussed in the prvious section, you must consider a a few thing for backup operations with HSR-enabled HANA systems.

* A backup operation can only be executed at the primary HANA host. Therefore CBA must be aware of which host is currently the primary when executing a backup operation.
** The backup SQL statements must be executed against the current primary host.
** A Snapshot backup should only be taken at the primary host data volume, because the secondary host data volume is not in a consistent state and is therefore useless for a restore and recovery operation.
* Retention management of Snapshot backups must be performed across both hosts. For example, when a failover to the secondary host has been executed, the backups of the former primary host must also be deleted based on the defined retention on all layers, in CBA, on the ANF volume,  and within the HANA backup catalog. Otherwise deleting old log backups based on log backup retention management is blocked due to old data backups.

In CBA, both HANA hosts, the primary and the secondary, are configured just like normal HANA systems as shown in the figure below. The only difference during configuration is a checkbox that is marked to tell CBA that this HANA system is part of a HSR ralationship. CBA reads the HSR status from the hosts and can find out which hosts belong together and which host is primary or secondary. For CBA internally, these two hosts are treated as a single entity, where a backup is only executed against the current primary host and the retention management is performed across both hosts.

[NOTE]
CBA only supports HSR for a two-host configuration.

image:anf-cba-image104.png[This figure shows how CBA only supports HSR for a two-host configuration.]

== Overview of installation and configuration steps

There are some minor differences in the required configuration steps for an HSR-enabled HANA system. In this section, we only highlight the differences compared to the already described standard configuration steps.

. Create a backup user at the HANA system database at the primary HSR host.
. Add the primary host and configure the HANA system in Cloud Backup for Applications.
.. Select *HANA System Replication* during configuration.
+
image:anf-cba-image105.png["Screenshot of the step being completed."]

.. Add the storage footprint of the primary host.
+
image:anf-cba-image106.png["Screenshot of the step being completed."]

. The new HANA system is now listed with an HSR icon.
+
image:anf-cba-image107.png["Screenshot of the step being completed."]

. Add a secondary host and configure the HANA system in Cloud Backup for Applications.
.. Select *HANA System Replication* during configuration.
+
image:anf-cba-image108.png["Screenshot of the step being completed."]

.. Add the storage footprint of the secondary host.
+
image:anf-cba-image109.png["Screenshot of the step being completed."]
+
Both system are now listed with the HSR icon.
+
image:anf-cba-image110.png["Screenshot of the step being completed."]

. Add backup policies to the primary and secondary HANA system.
+
[NOTE]
You must add the same policies to both systems because retention management is performed across both HANA hosts.

Backups are now executed based on the defined policies. CBA always triggers the Snapshot backup operation at the primary HANA host.

== Backup operations with HANA multiple-host systems

The HANA database executes Snapshot backups in the same way as for single-host systems. The backup operation SQL commands must be triggered at the system database, and the HANA backup savepoint is created for all HANA worker nodes so that all data volumes of each node are consistent. As a next step, the storage Snapshot operations must be performed on each data volume.

=== HANA multiple-host systems without standby host

A HANA multiple-host system without a standby host is configured in CBA in a manner similar to a HANA single-host system.

. The HANA plug-in needs to be installed on the worker node, where the HANA nameserver and system database is running. The worker nodes running the Indexservers do not require the HANA plug-in.
. The HDB user store key is configured for the system database in the same way as for a HANA single-host system.
. In the configuration of the storage footprint, all data volumes of the HANA system must be added.
+
In the following example, you would add Data1, Data2, and Data3 volumes.
+
[NOTE]
The data volumes of each HANA host must be mounted on each host in the same way as the configuration of a standby host. Cloud Backup for Applications creates a list of files included in the backup and therefore needs to have access to all volumes belonging to the HANA system. The file list is required for single-file restore operations when ANF cross-region replication or ANF backup is enabled.
+
image:anf-cba-image111.png["This figure shows how a HANA plugin must be installed on worker nodes where the Nameserver/systemDB runs."]

=== HANA multiple-host systems with standby host

With the current CBA version, HANA multiple-host systems with a standby host are supported with the assumption that, after a failover of the nameserver to the standby host, the failed host gets restarted and then comes up with the same OS configuration, file system mounts, and HANA plugin.

A HANA multiple-host system with standby host is configured in CBA with the following steps.

. The HANA plug-n must be installed on the worker node, where the HANA nameserver/system database is running.

. The HDB user store key is configured with two hosts, the system database (name server host) and the standby host. The host:port strings in the CBA key configuration must be separated with a semicolon, and the list must start and end with double quotes. The hdbsql client then starts with the first entry in the user store key and will try to connect to the database. If the entry doesn’t work, the next entry is used. It is therefore important to configure the primary nameserver host as the first and the standby host as the second entry in the user store key.
+
image:anf-cba-image112.png["This screenshot shows the Add User Store screen with appropriate information filled in."]

. All data volumes of the HANA system must be added to the configuration of the storage footprint.
+
In the example shown in the figure below, you would need to add Data1 and Data2 volumes.
+
image:anf-cba-image113.png["This figure shows how add Data1 and Data2 to the Worker Nameservers and the Standby."]

In case of a failover of the nameserver to the standby host, it is assumed that the failed host is restarted in a short time frame and comes up with the same configuration as before. In this case, the HANA plugin and the hdbsql and hdb user store components are available and can continued to be used for backup operations.

With the user store configuration described before, the hdbsql client now uses the second host entry that points to the current nameserver host and executes backup operations.

image:anf-cba-image114.png["This figure shows the failed VM is restarted and acts as the new standby host after a failover to the standby host."]

link:anf-cba-where-to-find-additional-information-and-version-history.html[Next: Where to find additional information and version history.]

