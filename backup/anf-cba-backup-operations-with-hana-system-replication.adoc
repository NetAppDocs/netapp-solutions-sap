---
sidebar: sidebar
permalink: backup/anf-cba-backup-operations-with-hana-system-replication.html
keywords: system replication, cba, hsr, multiple host, standby host
summary: "This section describes how to perform backup operations with HANA system replication."
---

= Backup operations with HANA System Replication
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./../media/

//
// This file was created with NDAC Version 2.0 (August 17, 2020)
//
// 2023-03-16 10:24:27.321926
//

link:anf-cba-restore-and-recovery-from-snapshot-backup.html[Previous: Restore and recovery from Snapshot backup.]

== Storage Snapshot backups and HANA System Replication

Backup operations are always performed at the primary SAP HANA host because the required SQL commands for the backup operation cannot be performed at the secondary SAP HANA host.

For SAP HANA backup operations, the primary and secondary SAP HANA hosts are a single entity. They share the same SAP HANA backup catalog, and they use backups for restore and recovery, regardless of whether the backup was created at the primary or secondary SAP HANA host.

The ability to use any backup for restore and to do forward recovery using log backups from both hosts requires a shared log backup location that is accessible from both hosts. NetApp recommends that you use a shared storage volume. However, you should also separate the log backup destination into subdirectories within the shared volume.

Each SAP HANA host has its own storage volume. When you use a storage-based Snapshot to perform a backup, a database-consistent Snapshot copy is created on the primary SAP HANA host’s storage volume.

image:anf-cba-image102.png["This figure shows how a database-consistent Snapshot copy is created on the primary SAP HANA host’s storage volume."]

When a failover to host 2 is performed, host 2 becomes the primary SAP HANA host, backups are now executed at host 2, and Snapshot backups are created at the storage volume of host 2.

The backup created at host 2 can be restored directly at the storage layer. If you must use a backup created at host 1, then the backup must be copied from the host 1 storage volume to the host 2 storage volume. Forward recovery uses the log backups from both hosts.

image:anf-cba-image103.png["This figure shows how forward recovery uses the log backups from both hosts."]

== Backup operations with CBA- and HSR-enabled HANA systems

As briefly discussed in the prvious section, you must consider a a few thing for backup operations with HSR-enabled HANA systems.

* A backup operation can only be executed at the primary HANA host. Therefore CBA must be aware of which host is currently the primary when executing a backup operation.
** The backup SQL statements must be executed against the current primary host.
** A Snapshot backup should only be taken at the primary host data volume, because the secondary host data volume is not in a consistent state and is therefore useless for a restore and recovery operation.
* Retention management of Snapshot backups must be performed across both hosts. For example, when a failover to the secondary host has been executed, the backups of the former primary host must also be deleted based on the defined retention on all layers, in CBA, on the ANF volume,  and within the HANA backup catalog. Otherwise deleting old log backups based on log backup retention management is blocked due to old data backups.

In CBA, both HANA hosts, the primary and the secondary, are configured just like normal HANA systems as shown in the figure below. The only difference during configuration is a checkbox that is marked to tell CBA that this HANA system is part of a HSR ralationship. CBA reads the HSR status from the hosts and can find out which hosts belong together and which host is primary or secondary. For CBA internally, these two hosts are treated as a single entity, where a backup is only executed against the current primary host and the retention management is performed across both hosts.

[NOTE]
CBA only supports HSR for a two-host configuration.

image:anf-cba-image104.png[This figure shows how CBA only supports HSR for a two-host configuration.]

== Overview of installation and configuration steps

There are some minor differences in the required configuration steps for an HSR-enabled HANA system. In this section, we only highlight the differences compared to the already described standard configuration steps.

. Create a backup user at the HANA system database at the primary HSR host.
. Add the primary host and configure the HANA system in Cloud Backup for Applications.
.. Select *HANA System Replication* during configuration.
+
image:anf-cba-image105.png["Screenshot of the step being completed."]

.. Add the storage footprint of the primary host.
+
image:anf-cba-image106.png["Screenshot of the step being completed."]

. The new HANA system is now listed with an HSR icon.
+
image:anf-cba-image107.png["Screenshot of the step being completed."]

. Add a secondary host and configure the HANA system in Cloud Backup for Applications.
.. Select *HANA System Replication* during configuration.
+
image:anf-cba-image108.png["Screenshot of the step being completed."]

.. Add the storage footprint of the secondary host.
+
image:anf-cba-image109.png["Screenshot of the step being completed."]
+
Both system are now listed with the HSR icon.
+
image:anf-cba-image110.png["Screenshot of the step being completed."]

. Add backup policies to the primary and secondary HANA system.
+
[NOTE]
You must add the same policies to both systems because retention management is performed across both HANA hosts.

Backups are now executed based on the defined policies. CBA always triggers the Snapshot backup operation at the primary HANA host.

== Backup operations with HANA multiple-host systems

The HANA database executes Snapshot backups in the same way as for single-host systems. The backup operation SQL commands must be triggered at the system database, and the HANA backup savepoint is created for all HANA worker nodes so that all data volumes of each node are consistent. As a next step, the storage Snapshot operations must be performed on each data volume.

== HANA multiple-host systems without standby host

A HANA multiple-host system without a standby host is configured in a manner similar to a HANA single-host system.

. The HANA plug-in needs to be installed on the worker node, where the HANA nameserver and system database is running. The worker nodes running the index servers do not require the HANA plug-in.
. The HDB user store key is configured for the system database in the same way as for a HANA single-host system.
. In the configuration of the storage footprint, all data volumes of the HANA system must be added.
+
In the following example, you would add Data1, Data2, and Data3 volumes.
+
image:anf-cba-image111.png["This figure shows how a HANA plugin must be installed on worker nodes where the Nameserver/systemDB runs."]

== HANA multiple-host systems with standby host

HANA multiple-host systems with a standby host are not directly supported with the current CBA version. When the HANA system is configured as shown in the figure below, a failover of the HANA nameserver to the standby node leads to a failure of all backups, because the plug-in host configured in CBA does not work anymore.

image:anf-cba-image112.png["This figure shows how a failover of the HANA nameserver to the standby node leads to a failure of all backups, because the plug-in host configured in CBA does not work anymore."]

As a workaround, you can configure a HANA multiple-host system with a standby host by adding the HANA nameserver host and the standby host to CBA. During normal operation, you must put the standby host in maintenance mode in CBA. In case of a failover, you must activate the standby host in CBA, and you must put the former nameserver host in maintenance mode.

. Install the HANA plugin on the worker node where the HANA nameserver and system database is running.
. Configure the HDB user store key for the system database in the same way as for a HANA single host system.
. In the configuration of the storage footprint, you must add all data volumes for the HANA system. In the example shown in the figure below, add the Data1 and Data2 volumes.
. After successful testing of backup operations, put the HANA system in maintenance mode in CBA.
. Initiate a failover of the HANA nameserver to the standby host.
. Now, install the HANA plug-in on the standby host, and configure CBA in the same way as described before.
. After successful testing of backup operations, put the HANA system in maintenance mode in CBA.
. A failover to the original nameserver host is executed.
. Activate the original HANA system in CBA, and then execute backup operations.
+
image:anf-cba-image113.png[This figure shows how to activate the original HANA system in CBA, and then execute backup operations.]

link:anf-cba-where-to-find-additional-information-and-version-history.html[Next: Where to find additional information and version history.]

