---
sidebar: sidebar
permalink: backup/anf-cba-cloud-backup-for-applications-architecture.html
keywords: applications, anf, strategy, data protection, backup
summary: "Cloud Backup for Applications is a SaaS solution that provides data protection capabilities for applications running on NetApp cloud storage. Cloud Backup for Applications enabled within NetApp BlueXP offers efficient, application-consistent, policy-based protection of SAP HANA on Azure NetApp Files. Cloud Backup for Applications provides centralized control and oversight, while delegating the ability for users to manage application-specific backup and restore operations."
---

= Cloud Backup for Applications architecture
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./../media/

//
// This file was created with NDAC Version 2.0 (August 17, 2020)
//
// 2023-03-16 10:24:27.210933
//

link:anf-cba-use-cases-and-value-of-accelerated-backup-and-cloning-operations_overview.html[Previous: Cloud Backup for Applications architecture overview.]

[.lead]
Cloud Backup for Applications is a SaaS solution that provides data protection capabilities for applications running on NetApp cloud storage. Cloud Backup for Applications enabled within NetApp BlueXP offers efficient, application-consistent, policy-based protection of SAP HANA on Azure NetApp Files. Cloud Backup for Applications provides centralized control and oversight, while delegating the ability for users to manage application-specific backup and restore operations.

Cloud Backup for Applications runs as SaaS within NetApp BlueXP and leverages the framework and UI.  The BlueXP working environment framework is used to configure and manage the credentials for Azure NetApp Files.

A BlueXP connector must be deployed within the customer vNet. Communication between the NetApp SaaS components and the customer environment is performed exclusively through the connector. The connector is executing the ANF storage operations by using the ANF management APIs.

The HANA plug-in provides the HANA database with specific logic and must be deployed on each HANA host. The HANA plug-in communicates with the HANA database using the HANA hdbsql client and a user store key. All database operations are triggered by the BlueXP connector.

image:anf-cba-image5.png["This image depicts the basic architecture for NetApp SaaS in combination with the customer network and an Azure subscription."]

== Cloud Backup for Applications for SAP HANA on ANF

=== Solution overview

Cloud Backup for Application supports Snapshot-based backup operations for the following components:

. *SAP HANA system* data volume(s).
. *Non-data volume(s)* of an SAP HANA database. For example, the `/hana/shared` volume and/or SAP application server data.
. *Global non-data volume(s)* that do not belong to a specific HANA system. For example, the SAP transport directory `/usr/sap/trans`.

The backup operations of these components include the following:

* Scheduled or on-demand backups
* Optional pre- and post-scripts
* Policy-driven retention management
** for Snapshot(s) on the ANF-volume level
** within the SAP HANA backup catalog (for HANA data volume backups)

SAP HANA file-based backups are used for database block integrity checks and can also be executed either on-demand or as scheduled backup operations. Policy-driven retention management is performed at the file-system level and within the HANA backup catalog.

Retention management of HANA database log backup is performed based on the defined retention of HANA database data backups (Snapshot- or file-based).

CBA supports restore operations for all Snapshot-based backups. File-based backups can only be restored using native HANA tools.

image:anf-cba-image6.png["This image depicts backup and restore for a HANA system multitenant database container and global non-data volumes."]

=== Solution operations

Snapshot data backups are executed with Cloud Backup for Applications by triggering the SAP HANA database backup savepoint so that the Snapshot copy, which is created on the storage layer, is based on a consistent image of the SAP HANA database. See the https://help.sap.com/docs/SAP_HANA_PLATFORM/6b94445c94ae495c83a19646e7c3fd56/b41a2823576f4726be649bc98e61d62c.html?q=sap%20hana%20snapshot%20backup[SAP Administration Guide^] for more information.

To enable a complete backup of all SAP HANA-related resources, Cloud Backup for Applications also enables you to back up all non-data volumes with storage-based Snapshot copies. You can schedule non-data volumes independently from the database data backup to enable individual retention and protection policies.

SAP recommends combining storage-based Snapshot backups with a weekly file-based backup to execute a block integrity check. You can execute the block integrity check from within CBA. Block integrity check (file-based) backups are also used to offload backups to a second storage location.

Based on your configurable retention policies, Cloud Backup for Applications manages the housekeeping of data backups, log backups, and the SAP HANA backup catalog.

The following figure summarizes the backup solution.

image:anf-cba-image7.png["This figure summarizes the backup solution."]

When executing a storage-based Snapshot backup of non-data volumes, Cloud Backup for Applications performs the following tasks:

. Creates a storage Snapshot copy of the non-data volume.
. Deletes storage Snapshot copies based on the defined retention policy.

When executing a storage-based Snapshot backup of the SAP HANA database, Cloud Backup for Applications performs the following tasks:

. Creates an SAP HANA backup savepoint to create a consistent image on the persistence layer.
. Creates a storage Snapshot copy of the data volume(s).
. Registers the storage Snapshot backup in the SAP HANA backup catalog.
. Releases the SAP HANA backup savepoint.
. Deletes storage Snapshot copies based on the defined retention policy.
. Deletes SAP HANA backup catalog entries based on the defined retention policy.
. Whenever a data backup has been deleted manually or based on the retention policy, Cloud Backup for Applications deletes all log backups that are older than the oldest data backup. Log backups are deleted on the file system and in the SAP HANA backup catalog.

=== Supported SAP HANA releases and configurations

Cloud Backup for Applications supports HANA MDC systems with a single or with multiple tenants with the following configuration options:

* SAP HANA 2.0 SPS4 and later
* SAP HANA single-host systems 
* SAP HANA multiple-host systems as described in the section link:anf-cba-backup-operations-with-hana-system-replication.html#backup-operations-with-hana-multiple-host-systems[“Backup operations with HANA multiple-host systems"]
* SAP HANA system configured with HANA System Replication (HSR) as described in the section link:anf-cba-backup-operations-with-hana-system-replication.html[“Backup operations with HANA System Replication”]

== Cloud Backup for Applications concepts and best practices

=== Data protection strategy

Before configuring Cloud Backup for Applications, you must define the data protection strategy based on the RTO and RPO requirements of the various SAP systems.

A common approach is to define system types, such as production, development, test, or sandbox systems. All SAP systems of the same system type typically have the same data protection parameters.

You must define the following parameters:

* How often a Snapshot backup is executed
* How long a Snapshot backup is kept
* How often a block integrity check (file-based backups) is executed
* How long a block integrity check backup (file-based backup) is kept

The following table shows an example of data protection parameters for the system types production, development, and test. For the production system, a high backup frequency has been defined, and weekly file-based backups are executed. The test and the development systems have lower requirements, and Snapshot backups are scheduled less often.

|===
|Parameters |Production systems |Development systems |Test systems

|Snapshot backup frequency
|Every 4 hours
|Every 6 hours
|Every 12 hours
|Snapshot backup retention
|3 days
|3 days
|3 days
|Block integrity check frequency
|Once per week
|Once per week
|Once per week
|Block integrity check retention
|4 weeks
|2 weeks
|1 week
|===

The following table shows the policies that must be configured for the data protection parameters for Snapshot backup operations.

|===
|Parameters |Policy SnapshotEvery4h |Policy SnapshotEvery6h |Policy SnapshotEvery12h

|Backup type
|Snapshot based
|Snapshot based
|Snapshot based
|Schedule type
|Hourly
|Hourly
|Hourly
|Retention
|Count = 18
|Count = 12
|Count = 3
|Backup schedule
|Every 4 hours
|Every 6 hours
|Every 12 hours
|===

The following table shows the policies that must be configured for the data protection parameters for file-based backup operations.

|===
|Parameters |Policy FileBased4Week |Policy FileBased2Weeks |Policy FileBased1Week

|Backup type
|File based
|File based
|File based
|Schedule type
|Weekly
|Weekly
|Weekly
|Retention
|Count = 4
|Count = 2
|Count = 1
|Backup schedule
|Every Sunday
|Every Sunday
|Every Sunday
|===

== Backup operations

SAP introduced support for Snapshot backups in MDC multiple tenant systems with HANA 2.0 SPS4. In an SAP HANA MDC system, the tenant configuration is not necessarily static. You can add or delete tenants. Cloud Backup for Applications cannot rely on the configuration that is discovered when the HANA database is added to Cloud Backup for Applications. Cloud Backup for Applications must know which tenants are available at the point in time the backup operation is executed.

Therefore, with each backup operation, the first step in the workflow is to get the tenant information. The next step is the Snapshot backup operation itself. This step includes the SQL command to trigger the HANA backup savepoint, the ANF Snapshot backup, and the SQL command to close the HANA backup savepoint. By using the close command, the HANA database updates the backup catalog of the system database and each tenant.

[NOTE]
SAP HANA does not support Snapshot backup operations for MDC systems when one or more tenants are stopped.

For retention management of data backups and HANA backup catalog management, Cloud Backup for Applications must execute the catalog delete operations for the system database and all tenant databases that were identified in the first step. In the same way for the log backups, the Cloud Backup for Applications workflow must operate on each tenant that was part of the backup operation.

The following figure shows an overview of the backup workflow.

image:anf-cba-image8.png["This figure shows an overview of the backup workflow."]

=== Backup workflow for Snapshot backups of the HANA database

Cloud Backup for Applications backs up the SAP HANA database in the following sequence:

. Cloud Backup for Applications reads the list of tenants from the HANA database.
. Tenant information is stored in the Cloud Backup for Applications metadata for the backup operation.
. Cloud Backup for Applications triggers an SAP HANA global synchronized backup savepoint to create a consistent database image on the persistence layer.
+
[NOTE]
For an SAP HANA MDC single-  or multiple-tenant system, a synchronized global backup savepoint for the system database and for each tenant database is created with a single operation.

. Cloud Backup for Applications creates ANF Snapshot copies for all data volumes configured for the HANA system. For a single-host HANA database, there is only one data volume.  With an SAP HANA multiple-host database, there are multiple data volumes.
. Cloud Backup for Applications registers the Snapshot backup in the SAP HANA backup catalog.
. Cloud Backup for Applications deletes the SAP HANA backup savepoint.
. Cloud Backup for Applications deletes the ANF Snapshot copies and the backup entries in its database as well as in the SAP HANA backup catalog based on the retention policy defined for backups. HANA backup catalog operations are performed for the system database and all tenants.
. Cloud Backup for Applications deletes all log backups on the file system and in the SAP HANA backup catalog that are older than the oldest successful data backup identified in the SAP HANA backup catalog. These operations are performed for the system database and all tenants.

=== Backup workflow for block integrity check operations

Cloud Backup for Applications executes the block integrity check in the following sequence:

. Cloud Backup for Applications reads the list of tenants from the HANA database.
. Cloud Backup for Applications triggers a file-based backup operation for the system database and each tenant.
. Cloud Backup for Applications deletes file-based backups in its database, on the file system, and in the SAP HANA backup catalog based on the retention policy defined for block integrity check operations. Backup deletion on the file system and HANA backup catalog operations are performed for the system database and all tenants.
. Cloud Backup for Applications deletes all log backups on the file system and in the SAP HANA backup catalog that are older than the oldest data backup identified in the SAP HANA backup catalog. These operations are performed for the system database and all tenants.

== Backup retention management and housekeeping of data and log backups

Data backup retention management and log backup housekeeping can be divided into four main areas, including retention management of the following:

* Snapshot backups
* File-based backups
* Data backups in the SAP HANA backup catalog
* Log backups in the SAP HANA backup catalog and the file system

The following figure provides an overview of the different workflows and the dependencies of each operation. The following sections describe the different operations in detail.

image:anf-cba-image9.png["This figure provides an overview of the different workflows and the dependencies of each operation."]

=== Retention management of Snapshot backups

Cloud Backup for Applications handles the housekeeping of SAP HANA database backups and non-data volume backups by deleting Snapshot copies on the storage and in the Cloud Backup for Applications repository according to retention defined in the Cloud Backup for Applications backup policy.

Retention management logic is executed with each backup workflow in Cloud Backup for Applications.

You can also delete Snapshot backups manually in Cloud Backup for Applications.

=== Retention management of file-based backups

Cloud Backup for Applications handles the housekeeping of file-based backups by deleting the backups on the file system according to retention defined in the Cloud Backup for Applications backup policy.

Retention management logic is executed with each backup workflow in Cloud Backup for Applications.

=== Retention management of data backups within the SAP HANA backup catalog

When Cloud Backup for Applications deletes any backup (Snapshot or file-based), this data backup is also deleted in the SAP HANA backup catalog.

=== Retention management of log backups

The SAP HANA database automatically creates log backups. These log-backup runs create backup files for each individual SAP HANA service in a backup directory configured in SAP HANA.

Log backups older than the oldest successful data backup are no longer required for forward recovery and can therefore be deleted.

Cloud Backup for Applications handles the housekeeping of log file backups on the file system level as well as in the SAP HANA backup catalog by executing the following steps:

* Cloud Backup for Applications reads the SAP HANA backup catalog to get the backup ID of the oldest successful file-based or Snapshot backup.
* Cloud Backup for Applications deletes all log backups in the SAP HANA catalog and in the file system that are older than this backup ID.

[NOTE]
Cloud Backup for Applications only handles housekeeping for backups that have been created by Cloud Backup for Applications. If any additional data backups are created outside of Cloud Backup for Applications, you must make sure that the data backups are deleted from the backup catalog. If such a data backup is not deleted manually from the backup catalog, it can become the oldest data backup, and older log backups are not deleted until this data backup is deleted.

[NOTE]
Log backup housekeeping is enabled by default but can be disabled on the HANA plug-in host level. Edit the `hana.property` file `/opt/NetApp/snapcenter/scc/etc`. Including the parameter `LOG_CLEANUP_DISABLE = Y` in the `hana.property` configuration file disables the log backup housekeeping. If the file does not exist, you must create it.

== Enable secure communication to the HANA database

If the HANA database is configured with secure communication, the `hdbsql` command that is executed by CBA must use additional command-line options. This can be achieved by using a wrapper script that calls `hdbsql` with the required options.

[NOTE]
There are various options to configure SSL communication. In the following examples, the simplest client configuration is described using the command line option, where no server certificate validation is done. If certificate validation on the server and/or client side is required, different hdbsql command line options are needed, and you must configure the PSE environment accordingly as described in the SAP HANA Security Guide.

Instead of configuring the `hdbsql` executable in the `hana.properties` files, you add the wrapper script. In the file `/opt/NetApp/snapcenter/scc/etc/hana.properties`, you must add the following content.  If the file does not exist, you must create it.

This example is for a HANA system with SID=SM1 and instance number=12.

....
HANA_HDBSQL_CMD = /usr/sap/SM1/HDB12/exe/hdbsqls
....

The wrapper script `hdbsqls` calls `hdbsql` with the required command-line options.

....
#/bin/bash
/usr/sap/SM1/HDB12/exe/hdbsql -e -ssltrustcert $*
....

== Capacity requirements for Snapshot backups

You must consider the higher block change rate on the storage layer relative to the change rate with traditional databases. Due to the HANA table- merge process of the column store, the complete table is written to disk, not just the changed data in the table.

Data from our customer base shows a daily change rate between 20% and 50% per day if multiple Snapshot backups are taken during the day.

link:anf-cba-overview-of-installation-and-configuration-steps.html[Next: Overview of installation and configuration steps.]